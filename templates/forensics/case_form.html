{% extends 'base.html' %}

{% block title %}{% if case %}Edit Case{% else %}New Case{% endif %} - Diamond Forensics{% endblock %}

{% block content %}
<div class="w-full space-y-6">
    <!-- Breadcrumbs -->
    {% include 'components/breadcrumbs.html' %}
    
    <div>
        <h2 class="text-3xl font-bold text-foreground">{% if case %}Edit Case{% else %}New Case{% endif %}</h2>
        <p class="text-muted-foreground mt-1">{% if case %}Update case information{% else %}Create a new forensic investigation case{% endif %}</p>
    </div>

    <div class="card">
        <div class="card-body">
            <form method="post" class="space-y-6" id="caseForm">
                {% csrf_token %}
                <input type="hidden" name="confirm_duplicate_name" id="confirmDuplicateName" value="false">
                
                <div>
                    <label for="case_number" class="form-label">Case Number{% if not case %} (Optional){% endif %}</label>
                    <input type="text" id="case_number" name="case_number" value="{{ case.case_number|default:'' }}"
                        class="form-input"
                        placeholder="{% if case %}{{ case.case_number }}{% else %}Leave empty to auto-generate (e.g., 25-0001){% endif %}">
                    <p class="form-help">{% if case %}Update the case number if needed.{% else %}Format: YY-NNNN. Leave blank to auto-generate based on current year.{% endif %}</p>
                    <div class="mt-2 flex items-start gap-2 px-3 py-2 bg-warning/10 border border-warning/30 rounded-lg">
                        <svg class="w-4 h-4 text-warning mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <p class="text-xs text-warning"><strong>Warning:</strong> Case numbers must be unique. Duplicates will not be allowed.</p>
                    </div>
                    <div id="case-number-error" class="hidden mt-2 flex items-start gap-2 px-3 py-2 bg-destructive/10 border border-destructive/30 rounded-lg">
                        <svg class="w-4 h-4 text-destructive mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        <p class="text-xs text-destructive"><strong>Error:</strong> This case number already exists. Please choose a different one or leave blank to auto-generate.</p>
                    </div>
                </div>
                
                <div>
                    <label for="case_name" class="form-label">Case Name *</label>
                    <input type="text" id="case_name" name="case_name" required value="{{ case.case_name|default:'' }}"
                        class="form-input"
                        placeholder="Enter case name">
                    <div id="case-name-warning" class="hidden mt-2 flex items-start gap-2 px-3 py-2 bg-warning/10 border border-warning/30 rounded-lg">
                        <svg class="w-4 h-4 text-warning mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <p class="text-xs text-warning"><strong>Notice:</strong> This case name already exists. You will be asked to confirm before proceeding.</p>
                    </div>
                </div>
                
                <div>
                    <label for="description" class="form-label">Description</label>
                    <textarea id="description" name="description" rows="4"
                        class="form-textarea"
                        placeholder="Enter case description">{{ case.description|default:'' }}</textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="status" class="form-label">Status *</label>
                        <select id="status" name="status" required class="form-select">
                            <option value="active" {% if case.status == 'active' %}selected{% endif %}>Active</option>
                            <option value="closed" {% if case.status == 'closed' %}selected{% endif %}>Closed</option>
                            <option value="suspended" {% if case.status == 'suspended' %}selected{% endif %}>Suspended</option>
                            <option value="archived" {% if case.status == 'archived' %}selected{% endif %}>Archived</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="priority" class="form-label">Priority *</label>
                        <select id="priority" name="priority" required class="form-select">
                            <option value="low" {% if case.priority == 'low' %}selected{% endif %}>Low</option>
                            <option value="medium" {% if case.priority == 'medium' %}selected{% endif %}>Medium</option>
                            <option value="high" {% if case.priority == 'high' %}selected{% endif %}>High</option>
                            <option value="critical" {% if case.priority == 'critical' %}selected{% endif %}>Critical</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="case_type" class="form-label">Case Type</label>
                        <input type="text" id="case_type" name="case_type" value="{{ case.case_type|default:'' }}"
                            class="form-input"
                            placeholder="E.g. Fraud, Cybercrime, Theft, etc. (optional)">
                    </div>
                    
                    <div>
                        <label for="department" class="form-label">Department</label>
                        <select id="department" name="department" class="form-select">
                        <option value="">-- Select Department --</option>
                        <option value="sur" {% if case.department == 'sur' %}selected{% endif %}>SUR</option>
                        <option value="ar" {% if case.department == 'ar' %}selected{% endif %}>AR</option>
                        <option value="jzz" {% if case.department == 'jzz' %}selected{% endif %}>JZZ</option>
                        <option value="zwacri" {% if case.department == 'zwacri' %}selected{% endif %}>ZwaCri</option>
                        <option value="fraude" {% if case.department == 'fraude' %}selected{% endif %}>Fraude</option>
                        <option value="umm" {% if case.department == 'umm' %}selected{% endif %}>UMM</option>
                        <option value="alpha" {% if case.department == 'alpha' %}selected{% endif %}>Alpha</option>
                        <option value="douane" {% if case.department == 'douane' %}selected{% endif %}>Douane</option>
                        <option value="ind" {% if case.department == 'ind' %}selected{% endif %}>IND</option>
                        <option value="verkeer" {% if case.department == 'verkeer' %}selected{% endif %}>Verkeer</option>
                        <option value="kustwacht" {% if case.department == 'kustwacht' %}selected{% endif %}>Kustwacht</option>
                        <option value="pelican" {% if case.department == 'pelican' %}selected{% endif %}>Pelican</option>
                        <option value="other" {% if case.department == 'other' %}selected{% endif %}>Other</option>
                    </select>
                </div>
            </div>
            
                <div>
                    <label for="prosecutor" class="form-label">Prosecutor</label>
                    <input type="text" id="prosecutor" name="prosecutor" value="{{ case.prosecutor|default:'' }}" list="prosecutor-list"
                        class="form-input"
                        placeholder="Select or type prosecutor name">
                    <datalist id="prosecutor-list">
                        {% for prosecutor in prosecutors %}
                        <option value="{{ prosecutor }}">
                        {% endfor %}
                    </datalist>
                    <p class="form-help">Select from list or type a new name</p>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="btn btn-primary">
                        {% if case %}Update Case{% else %}Create Case{% endif %}
                    </button>
                    <button type="button" onclick="window.history.back();" class="btn btn-secondary">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Duplicate Case Number Modal -->
<div id="duplicateNumberModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="card max-w-md w-full">
        <div class="card-body">
            <div class="flex items-start gap-4">
                <div class="flex-shrink-0">
                    <svg class="w-12 h-12 text-destructive" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-foreground mb-2">Duplicate Case Number</h3>
                    <p class="text-sm text-foreground mb-4">The case number "<span id="duplicateCaseNumber" class="font-semibold text-warning"></span>" already exists in the system.</p>
                    <p class="text-sm text-muted-foreground">Case numbers must be unique. Please choose a different case number or leave the field blank to auto-generate a unique one.</p>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="button" id="clearCaseNumber" class="btn btn-primary flex-1">
                    Clear & Auto-Generate
                </button>
                <button type="button" id="closeNumberModal" class="btn btn-secondary flex-1">
                    Edit Case Number
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Duplicate Case Name Modal -->
<div id="duplicateNameModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="card max-w-lg w-full">
        <div class="card-body">
            <div class="flex items-start gap-4">
                <div class="flex-shrink-0">
                    <svg class="w-12 h-12 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-foreground mb-2">Similar Case Name Detected</h3>
                    <p class="text-sm text-foreground mb-3">The case name "<span id="duplicateCaseName" class="font-semibold text-warning"></span>" already exists in the following case(s):</p>
                    <div id="existingCasesList" class="bg-muted rounded-lg p-3 mb-4 max-h-40 overflow-y-auto">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <p class="text-sm text-muted-foreground">Are you sure you want to create a new case with this name? This may be intentional if it's for a different year or related case.</p>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="button" id="proceedWithDuplicateName" class="btn btn-primary flex-1">
                    Yes, Proceed
                </button>
                <button type="button" id="closeNameModal" class="btn btn-secondary flex-1">
                    No, Edit Name
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const caseNumberInput = document.getElementById('case_number');
    const caseNameInput = document.getElementById('case_name');
    const numberErrorDiv = document.getElementById('case-number-error');
    const nameWarningDiv = document.getElementById('case-name-warning');
    const form = document.getElementById('caseForm');
    const originalCaseNumber = '{{ case.case_number|default:"" }}';
    const originalCaseName = '{{ case.case_name|default:"" }}';
    const numberModal = document.getElementById('duplicateNumberModal');
    const nameModal = document.getElementById('duplicateNameModal');
    const duplicateCaseNumberSpan = document.getElementById('duplicateCaseNumber');
    const duplicateCaseNameSpan = document.getElementById('duplicateCaseName');
    const existingCasesList = document.getElementById('existingCasesList');
    const clearButton = document.getElementById('clearCaseNumber');
    const closeNumberModalButton = document.getElementById('closeNumberModal');
    const closeNameModalButton = document.getElementById('closeNameModal');
    const proceedButton = document.getElementById('proceedWithDuplicateName');
    const confirmInput = document.getElementById('confirmDuplicateName');
    
    let debounceTimer;
    let isDuplicateNumber = false;
    let isDuplicateName = false;
    let existingCases = [];
    
    // Check case number
    caseNumberInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const value = this.value.trim();
        
        if (!value || value === originalCaseNumber) {
            numberErrorDiv.classList.add('hidden');
            caseNumberInput.classList.remove('border-red-500');
            isDuplicateNumber = false;
            return;
        }
        
        debounceTimer = setTimeout(() => {
            checkCaseNumberExists(value);
        }, 500);
    });
    
    // Check case name
    caseNameInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const value = this.value.trim();
        
        if (!value || value === originalCaseName) {
            nameWarningDiv.classList.add('hidden');
            caseNameInput.classList.remove('border-yellow-500');
            isDuplicateName = false;
            return;
        }
        
        debounceTimer = setTimeout(() => {
            checkCaseNameExists(value);
        }, 500);
    });
    
    function checkCaseNumberExists(caseNumber) {
        fetch(`/forensics/check-case-number/?case_number=${encodeURIComponent(caseNumber)}`)
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    numberErrorDiv.classList.remove('hidden');
                    caseNumberInput.classList.add('border-red-500');
                    isDuplicateNumber = true;
                } else {
                    numberErrorDiv.classList.add('hidden');
                    caseNumberInput.classList.remove('border-red-500');
                    isDuplicateNumber = false;
                }
            })
            .catch(error => {
                console.error('Error checking case number:', error);
            });
    }
    
    function checkCaseNameExists(caseName) {
        fetch(`/forensics/check-case-name/?case_name=${encodeURIComponent(caseName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.exists && data.cases.length > 0) {
                    nameWarningDiv.classList.remove('hidden');
                    caseNameInput.classList.add('border-yellow-500');
                    isDuplicateName = true;
                    existingCases = data.cases;
                } else {
                    nameWarningDiv.classList.add('hidden');
                    caseNameInput.classList.remove('border-yellow-500');
                    isDuplicateName = false;
                    existingCases = [];
                }
            })
            .catch(error => {
                console.error('Error checking case name:', error);
            });
    }
    
    // Form submission
    form.addEventListener('submit', function(e) {
        const caseNumber = caseNumberInput.value.trim();
        const caseName = caseNameInput.value.trim();
        
        // Hard block for duplicate case number
        if (isDuplicateNumber && caseNumber) {
            e.preventDefault();
            duplicateCaseNumberSpan.textContent = caseNumber;
            numberModal.classList.remove('hidden');
            return;
        }
        
        // Soft warning for duplicate case name (only if not already confirmed)
        if (isDuplicateName && caseName && confirmInput.value !== 'true') {
            e.preventDefault();
            duplicateCaseNameSpan.textContent = caseName;
            
            // Populate existing cases list
            existingCasesList.innerHTML = existingCases.map(c => 
                `<div class="text-sm text-foreground py-1 border-b border-border last:border-0">
                    <span class="font-semibold text-primary">${c.case_number}</span> - ${c.case_name}
                    <span class="text-xs text-muted-foreground">(${c.status})</span>
                </div>`
            ).join('');
            
            nameModal.classList.remove('hidden');
            return;
        }
    });
    
    // Clear case number and close modal
    clearButton.addEventListener('click', function() {
        caseNumberInput.value = '';
        numberErrorDiv.classList.add('hidden');
        caseNumberInput.classList.remove('border-red-500');
        isDuplicateNumber = false;
        numberModal.classList.add('hidden');
    });
    
    // Close number modal and focus on input
    closeNumberModalButton.addEventListener('click', function() {
        numberModal.classList.add('hidden');
        caseNumberInput.focus();
        caseNumberInput.select();
    });
    
    // Close name modal and focus on input
    closeNameModalButton.addEventListener('click', function() {
        nameModal.classList.add('hidden');
        caseNameInput.focus();
        caseNameInput.select();
    });
    
    // Proceed with duplicate name
    proceedButton.addEventListener('click', function() {
        confirmInput.value = 'true';
        nameModal.classList.add('hidden');
        form.submit();
    });
    
    // Close modals on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (!numberModal.classList.contains('hidden')) {
                numberModal.classList.add('hidden');
                caseNumberInput.focus();
            }
            if (!nameModal.classList.contains('hidden')) {
                nameModal.classList.add('hidden');
                caseNameInput.focus();
            }
        }
    });
});
</script>
{% endblock %}
