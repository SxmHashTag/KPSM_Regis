{% extends 'base.html' %}

{% block title %}Analytics - Diamond Forensics{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <div>
            <h2 class="text-3xl font-bold text-foreground">Analytics Dashboard</h2>
            <p class="text-muted-foreground mt-1">Comprehensive analytics for cases and evidence</p>
        </div>
        <a href="{% url 'dashboard' %}" class="px-4 py-2 bg-secondary text-foreground rounded-lg hover:bg-secondary/80 transition-colors">
            ‚Üê Back to Dashboard
        </a>
    </div>

    <!-- Advanced Filters Panel -->
    <div class="bg-gradient-to-br from-secondary to-secondary rounded-xl border-2 border-primary shadow-lg">
        <form method="get" class="p-6" id="analyticsFilterForm">
            <!-- Filter Header -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-foreground">Advanced Filters</h3>
                        <p class="text-sm text-muted-foreground">Customize your analytics view</p>
                    </div>
                </div>
                <button type="button" onclick="toggleFilters()" class="text-primary hover:text-purple-800 font-medium text-sm">
                    <span id="toggleText">Show All</span>
                </button>
            </div>
            
            <!-- Quick Period Buttons -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-foreground mb-3">Quick Time Periods</label>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-2">
                    <button type="button" onclick="setPeriod('1m')" class="px-4 py-2 rounded-lg font-medium text-sm transition-all {% if period == '1m' %}bg-primary text-foreground shadow-md{% else %}bg-secondary text-foreground border border-border hover:border-primary hover:bg-secondary/80{% endif %}">
                        Last Month
                    </button>
                    <button type="button" onclick="setPeriod('3m')" class="px-4 py-2 rounded-lg font-medium text-sm transition-all {% if period == '3m' %}bg-primary text-foreground shadow-md{% else %}bg-secondary text-foreground border border-border hover:border-primary hover:bg-secondary/80{% endif %}">
                        3 Months
                    </button>
                    <button type="button" onclick="setPeriod('6m')" class="px-4 py-2 rounded-lg font-medium text-sm transition-all {% if period == '6m' %}bg-primary text-foreground shadow-md{% else %}bg-secondary text-foreground border border-border hover:border-primary hover:bg-secondary/80{% endif %}">
                        6 Months
                    </button>
                    <button type="button" onclick="setPeriod('1y')" class="px-4 py-2 rounded-lg font-medium text-sm transition-all {% if period == '1y' %}bg-primary text-foreground shadow-md{% else %}bg-secondary text-foreground border border-border hover:border-primary hover:bg-secondary/80{% endif %}">
                        1 Year
                    </button>
                    <button type="button" onclick="setPeriod('all')" class="px-4 py-2 rounded-lg font-medium text-sm transition-all {% if period == 'all' %}bg-primary text-foreground shadow-md{% else %}bg-secondary text-foreground border border-border hover:border-primary hover:bg-secondary/80{% endif %}">
                        All Time
                    </button>
                    <button type="button" onclick="showCustomRange()" class="px-4 py-2 rounded-lg font-medium text-sm transition-all {% if period == 'custom' %}bg-primary text-foreground shadow-md{% else %}bg-secondary text-foreground border border-border hover:border-primary hover:bg-secondary/80{% endif %}">
                        Custom
                    </button>
                </div>
            </div>
            
            <!-- Advanced Filters (Collapsible) -->
            <div id="advancedFilters" class="space-y-6" style="display: none;">
                <!-- Custom Date Range -->
                <div id="customDateRange" class="bg-secondary rounded-lg p-4 border border-border">
                    <label class="block text-sm font-semibold text-foreground mb-3">Custom Date Range</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-muted-foreground mb-1">Start Date</label>
                            <input type="date" name="start_date" value="{{ start_date }}" 
                                   class="w-full px-3 py-2 border-2 border-border rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 transition-colors">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-muted-foreground mb-1">End Date</label>
                            <input type="date" name="end_date" value="{{ end_date }}" 
                                   class="w-full px-3 py-2 border-2 border-border rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 transition-colors">
                        </div>
                    </div>
                </div>
                
                <!-- Case Filters -->
                <div class="bg-secondary rounded-lg p-4 border border-border">
                    <label class="block text-sm font-semibold text-foreground mb-3">Case Filters</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-muted-foreground mb-1">Status</label>
                            <select name="case_status" class="w-full px-3 py-2 border-2 border-border rounded-lg focus:border-primary focus:ring-2 focus:ring-blue-200 transition-colors">
                                <option value="">All Statuses</option>
                                {% for value, label in case_status_choices %}
                                <option value="{{ value }}" {% if case_status_filter == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-muted-foreground mb-1">Priority</label>
                            <select name="case_priority" class="w-full px-3 py-2 border-2 border-border rounded-lg focus:border-primary focus:ring-2 focus:ring-blue-200 transition-colors">
                                <option value="">All Priorities</option>
                                {% for value, label in case_priority_choices %}
                                <option value="{{ value }}" {% if case_priority_filter == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-muted-foreground mb-1">Department</label>
                            <select name="case_department" class="w-full px-3 py-2 border-2 border-border rounded-lg focus:border-primary focus:ring-2 focus:ring-blue-200 transition-colors">
                                <option value="">All Departments</option>
                                {% for value, label in case_department_choices %}
                                <option value="{{ value }}" {% if case_department_filter == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Evidence Filters -->
                <div class="bg-secondary rounded-lg p-4 border border-border">
                    <label class="block text-sm font-semibold text-foreground mb-3">Evidence Filters</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-muted-foreground mb-1">Status</label>
                            <select name="evidence_status" class="w-full px-3 py-2 border-2 border-border rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 transition-colors">
                                <option value="">All Statuses</option>
                                {% for value, label in evidence_status_choices %}
                                <option value="{{ value }}" {% if evidence_status_filter == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-muted-foreground mb-1">Device Type</label>
                            <select name="evidence_device_type" class="w-full px-3 py-2 border-2 border-border rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 transition-colors">
                                <option value="">All Device Types</option>
                                {% for value, label in evidence_device_type_choices %}
                                <option value="{{ value }}" {% if evidence_device_type_filter == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-3 mt-6">
                <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-primary to-primary text-foreground rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all shadow-md font-semibold">
                    Apply Filters
                </button>
                <a href="{% url 'analytics_dashboard' %}" class="px-6 py-3 bg-secondary text-foreground rounded-lg hover:bg-secondary/80 transition-colors shadow-md font-semibold">
                    Reset
                </a>
            </div>
            
            <!-- Current Filter Summary -->
            {% if period != 'all' or start_date or end_date or case_status_filter or case_priority_filter or case_department_filter or evidence_status_filter or evidence_device_type_filter %}
            <div class="mt-4 p-3 card rounded-lg border border-primary">
                <p class="text-sm font-medium text-foreground">Active Filters:</p>
                <div class="flex flex-wrap gap-2 mt-2">
                    {% if period and period != 'all' %}
                    <span class="px-3 py-1 bg-primary text-foreground text-xs rounded-full font-medium">Period: {{ period_label }}</span>
                    {% endif %}
                    {% if start_date %}
                    <span class="px-3 py-1 bg-primary text-foreground text-xs rounded-full font-medium">From: {{ start_date }}</span>
                    {% endif %}
                    {% if end_date %}
                    <span class="px-3 py-1 bg-primary text-foreground text-xs rounded-full font-medium">To: {{ end_date }}</span>
                    {% endif %}
                    {% if case_status_filter %}
                    <span class="px-3 py-1 bg-primary text-foreground text-xs rounded-full font-medium">Case Status: {{ case_status_filter|title }}</span>
                    {% endif %}
                    {% if case_priority_filter %}
                    <span class="px-3 py-1 bg-primary text-foreground text-xs rounded-full font-medium">Priority: {{ case_priority_filter|title }}</span>
                    {% endif %}
                    {% if case_department_filter %}
                    <span class="px-3 py-1 bg-primary text-foreground text-xs rounded-full font-medium">Dept: {{ case_department_filter|upper }}</span>
                    {% endif %}
                    {% if evidence_status_filter %}
                    <span class="px-3 py-1 bg-amber-600 text-foreground text-xs rounded-full font-medium">Evidence Status: {{ evidence_status_filter|title }}</span>
                    {% endif %}
                    {% if evidence_device_type_filter %}
                    <span class="px-3 py-1 bg-amber-600 text-foreground text-xs rounded-full font-medium">Device: {{ evidence_device_type_filter|title }}</span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </form>
    </div>
    
    <script>
    function toggleFilters() {
        const filters = document.getElementById('advancedFilters');
        const toggleText = document.getElementById('toggleText');
        if (filters.style.display === 'none') {
            filters.style.display = 'block';
            toggleText.textContent = 'Hide Filters';
        } else {
            filters.style.display = 'none';
            toggleText.textContent = 'Show All';
        }
    }
    
    function setPeriod(period) {
        // Clear custom dates and other filters
        document.querySelector('input[name="start_date"]').value = '';
        document.querySelector('input[name="end_date"]').value = '';
        
        // Update URL with period
        window.location.href = '?period=' + period;
    }
    
    function showCustomRange() {
        const filters = document.getElementById('advancedFilters');
        const toggleText = document.getElementById('toggleText');
        filters.style.display = 'block';
        toggleText.textContent = 'Hide Filters';
        document.querySelector('input[name="start_date"]').focus();
    }
    
    // Show advanced filters if any are active
    {% if start_date or end_date or case_status_filter or case_priority_filter or case_department_filter or evidence_status_filter or evidence_device_type_filter %}
    document.addEventListener('DOMContentLoaded', function() {
        toggleFilters();
    });
    {% endif %}
    </script>

    <!-- Quick Comparison Cards -->
    <div class="bg-secondary rounded-lg border border-border p-6 shadow-md">
        <h3 class="text-lg font-semibold text-foreground mb-4">Period Comparison</h3>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div class="text-center p-4 rounded-lg {% if period == '1m' %}bg-gradient-to-br from-indigo-100 to-purple-100 border-2 border-indigo-300{% else %}card{% endif %}">
                <p class="text-xs font-medium text-muted-foreground mb-2">Last Month</p>
                <p class="text-2xl font-bold text-primary">{{ comparison.1m.cases }}</p>
                <p class="text-xs text-muted-foreground">Cases</p>
                <p class="text-2xl font-bold text-amber-600 mt-2">{{ comparison.1m.evidence }}</p>
                <p class="text-xs text-muted-foreground">Evidence</p>
            </div>
            <div class="text-center p-4 rounded-lg {% if period == '3m' %}bg-gradient-to-br from-indigo-100 to-purple-100 border-2 border-indigo-300{% else %}card{% endif %}">
                <p class="text-xs font-medium text-muted-foreground mb-2">Last 3 Months</p>
                <p class="text-2xl font-bold text-primary">{{ comparison.3m.cases }}</p>
                <p class="text-xs text-muted-foreground">Cases</p>
                <p class="text-2xl font-bold text-amber-600 mt-2">{{ comparison.3m.evidence }}</p>
                <p class="text-xs text-muted-foreground">Evidence</p>
            </div>
            <div class="text-center p-4 rounded-lg {% if period == '6m' %}bg-gradient-to-br from-indigo-100 to-purple-100 border-2 border-indigo-300{% else %}card{% endif %}">
                <p class="text-xs font-medium text-muted-foreground mb-2">Last 6 Months</p>
                <p class="text-2xl font-bold text-primary">{{ comparison.6m.cases }}</p>
                <p class="text-xs text-muted-foreground">Cases</p>
                <p class="text-2xl font-bold text-amber-600 mt-2">{{ comparison.6m.evidence }}</p>
                <p class="text-xs text-muted-foreground">Evidence</p>
            </div>
            <div class="text-center p-4 rounded-lg {% if period == '1y' %}bg-gradient-to-br from-indigo-100 to-purple-100 border-2 border-indigo-300{% else %}card{% endif %}">
                <p class="text-xs font-medium text-muted-foreground mb-2">Last Year</p>
                <p class="text-2xl font-bold text-primary">{{ comparison.1y.cases }}</p>
                <p class="text-xs text-muted-foreground">Cases</p>
                <p class="text-2xl font-bold text-amber-600 mt-2">{{ comparison.1y.evidence }}</p>
                <p class="text-xs text-muted-foreground">Evidence</p>
            </div>
            <div class="text-center p-4 rounded-lg {% if period == 'all' %}bg-gradient-to-br from-indigo-100 to-purple-100 border-2 border-indigo-300{% else %}card{% endif %}">
                <p class="text-xs font-medium text-muted-foreground mb-2">All Time</p>
                <p class="text-2xl font-bold text-primary">{{ comparison.all.cases }}</p>
                <p class="text-xs text-muted-foreground">Cases</p>
                <p class="text-2xl font-bold text-amber-600 mt-2">{{ comparison.all.evidence }}</p>
                <p class="text-xs text-muted-foreground">Evidence</p>
            </div>
        </div>
    </div>

    <!-- Cases Analytics Section -->
    <div class="card rounded-lg border border-border p-6 shadow-md">
        <h3 class="text-2xl font-bold text-foreground mb-6">Cases Analytics</h3>
        
        <!-- Case Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="bg-secondary rounded-lg p-4 border border-border">
                <p class="text-sm font-medium text-muted-foreground">Total Cases</p>
                <p class="text-3xl font-bold text-primary mt-2">{{ analytics.case_analytics.total_cases }}</p>
            </div>
            <div class="bg-secondary rounded-lg p-4 border border-border">
                <p class="text-sm font-medium text-muted-foreground">Active</p>
                <p class="text-3xl font-bold text-success mt-2">{{ analytics.case_analytics.active_cases }}</p>
            </div>
            <div class="bg-secondary rounded-lg p-4 border border-border">
                <p class="text-sm font-medium text-muted-foreground">Closed</p>
                <p class="text-3xl font-bold text-primary mt-2">{{ analytics.case_analytics.closed_cases }}</p>
            </div>
            <div class="bg-secondary rounded-lg p-4 border-2 border-yellow-200">
                <p class="text-sm font-medium text-muted-foreground">Suspended</p>
                <p class="text-3xl font-bold text-yellow-600 mt-2">{{ analytics.case_analytics.suspended_cases }}</p>
            </div>
            <div class="bg-secondary rounded-lg p-4 border-2 border-border">
                <p class="text-sm font-medium text-muted-foreground">Archived</p>
                <p class="text-3xl font-bold text-muted-foreground mt-2">{{ analytics.case_analytics.archived_cases }}</p>
            </div>
        </div>

        <!-- Case Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Status Distribution -->
            <div class="bg-secondary rounded-lg p-6 border border-border">
                <h4 class="text-lg font-semibold text-foreground mb-4">Cases by Status</h4>
                <canvas id="caseStatusChart" class="max-h-64"></canvas>
            </div>

            <!-- Priority Distribution -->
            <div class="bg-secondary rounded-lg p-6 border border-border">
                <h4 class="text-lg font-semibold text-foreground mb-4">Cases by Priority</h4>
                <canvas id="casePriorityChart" class="max-h-64"></canvas>
            </div>

            <!-- Case Type Distribution -->
            {% if analytics.case_analytics.case_type_distribution %}
            <div class="bg-secondary rounded-lg p-6 border border-border">
                <h4 class="text-lg font-semibold text-foreground mb-4">Cases by Type</h4>
                <canvas id="caseTypeChart" class="max-h-64"></canvas>
            </div>
            {% endif %}

            <!-- Department Distribution -->
            {% if analytics.case_analytics.department_distribution %}
            <div class="bg-secondary rounded-lg p-6 border border-border">
                <h4 class="text-lg font-semibold text-foreground mb-4">Cases by Department</h4>
                <canvas id="caseDepartmentChart" class="max-h-64"></canvas>
            </div>
            {% endif %}
        </div>

        <!-- Top Prosecutors -->
        {% if analytics.case_analytics.top_prosecutors %}
        <div class="bg-secondary rounded-lg p-6 border border-border mt-6">
            <h4 class="text-lg font-semibold text-foreground mb-4">Top Prosecutors</h4>
            <div class="space-y-2">
                {% for prosecutor in analytics.case_analytics.top_prosecutors %}
                <div class="flex justify-between items-center p-3 card rounded-lg">
                    <span class="font-medium text-foreground">{{ prosecutor.prosecutor }}</span>
                    <span class="text-sm font-semibold text-primary card px-3 py-1 rounded-full">{{ prosecutor.case_count }} cases</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Average Case Duration -->
        {% if analytics.case_analytics.avg_duration_days %}
        <div class="bg-secondary rounded-lg p-6 border border-border mt-6">
            <h4 class="text-lg font-semibold text-foreground mb-2">Average Case Duration</h4>
            <p class="text-4xl font-bold text-primary">{{ analytics.case_analytics.avg_duration_days }} days</p>
            <p class="text-sm text-muted-foreground mt-2">Average time from opening to closure</p>
        </div>
        {% endif %}
    </div>

    <!-- Evidence Analytics Section -->
    <div class="card rounded-lg border border-border p-6 shadow-md">
        <h3 class="text-2xl font-bold text-foreground mb-6">Evidence Analytics</h3>
        
        <!-- Evidence Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-secondary rounded-lg p-4 border border-border">
                <p class="text-sm font-medium text-muted-foreground">Total Evidence</p>
                <p class="text-3xl font-bold text-amber-600 mt-2">{{ analytics.evidence_analytics.total_evidence }}</p>
            </div>
            <div class="bg-secondary rounded-lg p-4 border border-border">
                <p class="text-sm font-medium text-muted-foreground">Assigned to Cases</p>
                <p class="text-3xl font-bold text-success mt-2">{{ analytics.evidence_analytics.assigned_to_case }}</p>
            </div>
            <div class="bg-secondary rounded-lg p-4 border border-border">
                <p class="text-sm font-medium text-muted-foreground">Unassigned</p>
                <p class="text-3xl font-bold text-red-600 mt-2">{{ analytics.evidence_analytics.unassigned }}</p>
            </div>
            <div class="bg-secondary rounded-lg p-4 border border-border">
                <p class="text-sm font-medium text-muted-foreground">With IBS#</p>
                <p class="text-3xl font-bold text-primary mt-2">{{ analytics.evidence_analytics.with_ibs }}</p>
            </div>
        </div>

        <!-- Evidence Status Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 mb-6">
            {% for status, count in analytics.evidence_analytics.by_status.items %}
            <div class="bg-secondary rounded-lg p-3 border border-border text-center">
                <p class="text-xs font-medium text-muted-foreground capitalize">{{ status }}</p>
                <p class="text-2xl font-bold text-amber-600 mt-1">{{ count }}</p>
            </div>
            {% endfor %}
        </div>

        <!-- Evidence Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Device Type Distribution -->
            <div class="bg-secondary rounded-lg p-6 border border-border">
                <h4 class="text-lg font-semibold text-foreground mb-4">Evidence by Device Type</h4>
                <canvas id="evidenceDeviceChart" class="max-h-64"></canvas>
            </div>

            <!-- Status Distribution -->
            <div class="bg-secondary rounded-lg p-6 border border-border">
                <h4 class="text-lg font-semibold text-foreground mb-4">Evidence by Status</h4>
                <canvas id="evidenceStatusChart" class="max-h-64"></canvas>
            </div>

            <!-- Department Distribution -->
            {% if analytics.evidence_analytics.department_distribution %}
            <div class="bg-secondary rounded-lg p-6 border border-border">
                <h4 class="text-lg font-semibold text-foreground mb-4">Evidence by Department</h4>
                <canvas id="evidenceDepartmentChart" class="max-h-64"></canvas>
            </div>
            {% endif %}
        </div>

        <!-- Top Examiners -->
        {% if analytics.evidence_analytics.top_examiners %}
        <div class="bg-secondary rounded-lg p-6 border border-border mt-6">
            <h4 class="text-lg font-semibold text-foreground mb-4">Top Examiners</h4>
            <div class="space-y-2">
                {% for examiner in analytics.evidence_analytics.top_examiners %}
                <div class="flex justify-between items-center p-3 card rounded-lg">
                    <span class="font-medium text-foreground">{{ examiner.examiner_name }}</span>
                    <span class="text-sm font-semibold text-amber-600 bg-amber-100 px-3 py-1 rounded-full">{{ examiner.count }} items</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Team/Department Breakdown -->
    <div class="bg-gradient-to-br from-secondary to-secondary rounded-lg border border-border p-6 shadow-md">
        <h3 class="text-2xl font-bold text-foreground mb-6">Team/Department Breakdown</h3>
        
        {% if analytics.case_analytics.department_distribution %}
        <div class="mb-6">
            <h4 class="text-lg font-semibold text-foreground mb-4">Cases by Team</h4>
            <div class="bg-secondary rounded-lg p-4 overflow-x-auto">
                <table class="w-full">
                    <thead class="card">
                        <tr class="border-b-2 border-border">
                            <th class="text-left py-3 px-4 font-semibold text-foreground">Department/Team</th>
                            <th class="text-center py-3 px-4 font-semibold text-foreground">Total Cases</th>
                            <th class="text-center py-3 px-4 font-semibold text-foreground">Active</th>
                            <th class="text-center py-3 px-4 font-semibold text-foreground">Closed</th>
                            <th class="text-center py-3 px-4 font-semibold text-foreground">Evidence Items</th>
                            <th class="text-right py-3 px-4 font-semibold text-foreground">Avg Evidence/Case</th>
                        </tr>
                    </thead>
                    <tbody id="teamStatsBody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        
        <!-- Team Performance Chart -->
        {% if analytics.case_analytics.department_distribution %}
        <div class="bg-secondary rounded-lg p-6 border border-border">
            <h4 class="text-lg font-semibold text-foreground mb-4">Team Performance Overview</h4>
            <canvas id="teamPerformanceChart" class="max-h-96"></canvas>
        </div>
        {% endif %}
    </div>

    <!-- Combined Metrics -->
    <div class="card rounded-lg border border-border p-6 shadow-md">
        <h3 class="text-2xl font-bold text-foreground mb-6">Combined Metrics</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% if analytics.avg_evidence_per_case %}
            <div class="bg-secondary rounded-lg p-6 border border-border">
                <h4 class="text-lg font-semibold text-foreground mb-2">Average Evidence per Case</h4>
                <p class="text-4xl font-bold text-primary">{{ analytics.avg_evidence_per_case }}</p>
                <p class="text-sm text-muted-foreground mt-2">Evidence items per case on average</p>
            </div>
            {% endif %}
            
            <div class="bg-secondary rounded-lg p-6 border border-border">
                <h4 class="text-lg font-semibold text-foreground mb-2">Cases Without Evidence</h4>
                <p class="text-4xl font-bold text-primary">{{ analytics.cases_without_evidence }}</p>
                <p class="text-sm text-muted-foreground mt-2">Cases with no evidence items assigned</p>
            </div>
        </div>
    </div>

    <!-- Monthly Trends -->
    {% if analytics.case_analytics.monthly_trend %}
    <div class="bg-secondary rounded-lg border-2 border-border p-6 shadow-md">
        <h3 class="text-2xl font-bold text-foreground mb-6">Monthly Trends</h3>
        <canvas id="monthlyTrendChart" class="max-h-80"></canvas>
    </div>
    {% endif %}
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Case Status Chart
const caseStatusCtx = document.getElementById('caseStatusChart');
if (caseStatusCtx) {
    new Chart(caseStatusCtx, {
        type: 'doughnut',
        data: {
            labels: {{ case_status_labels_json }},
            datasets: [{
                data: {{ case_status_counts_json }},
                backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#6b7280'],
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

// Case Priority Chart
const casePriorityCtx = document.getElementById('casePriorityChart');
if (casePriorityCtx) {
    new Chart(casePriorityCtx, {
        type: 'bar',
        data: {
            labels: {{ case_priority_labels_json }},
            datasets: [{
                label: 'Cases',
                data: {{ case_priority_counts_json }},
                backgroundColor: '#4f46e5',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// Case Type Chart
const caseTypeCtx = document.getElementById('caseTypeChart');
if (caseTypeCtx) {
    const caseTypeData = {{ case_type_distribution_json }};
    new Chart(caseTypeCtx, {
        type: 'pie',
        data: {
            labels: caseTypeData.map(item => item.case_type.replace('_', ' ').toUpperCase()),
            datasets: [{
                data: caseTypeData.map(item => item.count),
                backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

// Case Department Chart
const caseDepartmentCtx = document.getElementById('caseDepartmentChart');
if (caseDepartmentCtx) {
    const deptData = {{ case_department_distribution_json }};
    new Chart(caseDepartmentCtx, {
        type: 'bar',
        data: {
            labels: deptData.map(item => item.department.toUpperCase()),
            datasets: [{
                label: 'Cases',
                data: deptData.map(item => item.count),
                backgroundColor: '#4f46e5',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: { beginAtZero: true }
            }
        }
    });
}

// Evidence Device Type Chart
const evidenceDeviceCtx = document.getElementById('evidenceDeviceChart');
if (evidenceDeviceCtx) {
    const deviceData = {{ evidence_device_distribution_json }};
    new Chart(evidenceDeviceCtx, {
        type: 'bar',
        data: {
            labels: deviceData.slice(0, 10).map(item => item.device_type.replace('_', ' ').toUpperCase()),
            datasets: [{
                label: 'Evidence Items',
                data: deviceData.slice(0, 10).map(item => item.count),
                backgroundColor: '#f59e0b',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// Evidence Status Chart
const evidenceStatusCtx = document.getElementById('evidenceStatusChart');
if (evidenceStatusCtx) {
    const statusData = {{ evidence_status_distribution_json }};
    new Chart(evidenceStatusCtx, {
        type: 'doughnut',
        data: {
            labels: statusData.map(item => item.status.replace('_', ' ').toUpperCase()),
            datasets: [{
                data: statusData.map(item => item.count),
                backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#6b7280', '#8b5cf6', '#ec4899'],
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

// Evidence Department Chart
const evidenceDepartmentCtx = document.getElementById('evidenceDepartmentChart');
if (evidenceDepartmentCtx) {
    const deptData = {{ evidence_department_distribution_json }};
    new Chart(evidenceDepartmentCtx, {
        type: 'bar',
        data: {
            labels: deptData.map(item => item.current_department ? item.current_department.toUpperCase() : 'UNASSIGNED'),
            datasets: [{
                label: 'Evidence Items',
                data: deptData.map(item => item.count),
                backgroundColor: '#f59e0b',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: { beginAtZero: true }
            }
        }
    });
}

// Monthly Trend Chart
const monthlyTrendCtx = document.getElementById('monthlyTrendChart');
if (monthlyTrendCtx) {
    const trendData = {{ monthly_trend_json }};
    new Chart(monthlyTrendCtx, {
        type: 'line',
        data: {
            labels: trendData.map(item => {
                const date = new Date(item.month);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
            }),
            datasets: [
                {
                    label: 'Cases Opened',
                    data: trendData.map(item => item.opened),
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Cases Closed',
                    data: trendData.map(item => item.closed),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            },
            plugins: {
                legend: { position: 'top' }
            }
        }
    });
}

// Team Statistics Table
const teamStatsData = {{ team_stats_json }};
const teamStatsBody = document.getElementById('teamStatsBody');
if (teamStatsBody && teamStatsData.length > 0) {
    teamStatsData.forEach((team, index) => {
        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'card' : 'bg-secondary';
        row.innerHTML = `
            <td class="py-3 px-4 font-semibold text-foreground">${team.department_name}</td>
            <td class="py-3 px-4 text-center">
                <span class="px-3 py-1 bg-primary/20 text-primary rounded-full font-semibold">${team.total_cases}</span>
            </td>
            <td class="py-3 px-4 text-center">
                <span class="px-3 py-1 bg-success/20 text-success rounded-full font-semibold">${team.active_cases}</span>
            </td>
            <td class="py-3 px-4 text-center">
                <span class="px-3 py-1 bg-primary/20 text-primary rounded-full font-semibold">${team.closed_cases}</span>
            </td>
            <td class="py-3 px-4 text-center">
                <span class="px-3 py-1 bg-warning/20 text-warning rounded-full font-semibold">${team.total_evidence}</span>
            </td>
            <td class="py-3 px-4 text-right font-semibold text-primary">${team.avg_evidence_per_case}</td>
        `;
        teamStatsBody.appendChild(row);
    });
}

// Team Performance Chart
const teamPerformanceCtx = document.getElementById('teamPerformanceChart');
if (teamPerformanceCtx && teamStatsData.length > 0) {
    new Chart(teamPerformanceCtx, {
        type: 'bar',
        data: {
            labels: teamStatsData.map(team => team.department_name),
            datasets: [
                {
                    label: 'Total Cases',
                    data: teamStatsData.map(team => team.total_cases),
                    backgroundColor: '#4f46e5',
                    borderColor: '#4338ca',
                    borderWidth: 2
                },
                {
                    label: 'Active Cases',
                    data: teamStatsData.map(team => team.active_cases),
                    backgroundColor: '#10b981',
                    borderColor: '#059669',
                    borderWidth: 2
                },
                {
                    label: 'Evidence Items',
                    data: teamStatsData.map(team => team.total_evidence),
                    backgroundColor: '#f59e0b',
                    borderColor: '#d97706',
                    borderWidth: 2,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Cases'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Evidence Items'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const index = context.dataIndex;
                            const team = teamStatsData[index];
                            return [
                                `Critical: ${team.critical_cases}`,
                                `High Priority: ${team.high_priority_cases}`,
                                `Avg Evidence/Case: ${team.avg_evidence_per_case}`
                            ];
                        }
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}
